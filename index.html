<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FaceCall 1:1</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="controls">
  <button id="generateIdBtn">Generate My ID</button>
  <input type="text" id="peerIdInput" placeholder="Peer ID to call">
  <button id="callBtn">Call</button>
  <button id="endCallBtn">End Call</button>
  <button id="muteBtn">Mute/Unmute</button>
  <span id="status">Status: Idle</span>
  <span>Your ID: <strong id="myId"></strong></span>
  <button id="copyIdBtn">Copy ID</button>
</div>

<div id="videos">
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay muted playsinline></video>
</div>

<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
let localStream, currentCall, muted = false;
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const myIdSpan = document.getElementById('myId');
const statusSpan = document.getElementById('status');

const generateIdBtn = document.getElementById('generateIdBtn');
const callBtn = document.getElementById('callBtn');
const peerIdInput = document.getElementById('peerIdInput');
const endCallBtn = document.getElementById('endCallBtn');
const muteBtn = document.getElementById('muteBtn');
const copyIdBtn = document.getElementById('copyIdBtn');

const marvelCharacters = ["IronMan","SpiderMan","Thor","Hulk","BlackWidow","DoctorStrange","BlackPanther","CaptainAmerica","ScarletWitch","Vision"];
const digits = ["0","1","2","3","4","5","6","7","8","9"];

let peer;

function generateMarvelId() {
    const char = marvelCharacters[Math.floor(Math.random() * marvelCharacters.length)];
    const d1 = digits[Math.floor(Math.random() * digits.length)];
    const d2 = digits[Math.floor(Math.random() * digits.length)];
    return char + d1 + d2;
}

async function initLocalStream() {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;
}

// Generate PeerJS ID
generateIdBtn.onclick = async () => {
    await initLocalStream();

    const marvelId = generateMarvelId();
    peer = new Peer(marvelId, { debug: 2 });

    peer.on('open', id => {
        myIdSpan.textContent = id;
        statusSpan.textContent = 'Status: Ready';
        console.log('My Peer ID:', id);
    });

    peer.on('call', call => {
        currentCall = call;
        statusSpan.textContent = 'Status: Incoming Call';
        call.answer(localStream);
        call.on('stream', remoteStream => {
            remoteVideo.srcObject = remoteStream;
            statusSpan.textContent = 'Status: Connected';
        });
        call.on('close', () => {
            remoteVideo.srcObject = null;
            statusSpan.textContent = 'Status: Call Ended';
        });
    });

    peer.on('error', err => alert('PeerJS error: ' + err));
};

// Make a call
callBtn.onclick = () => {
    const remoteId = peerIdInput.value.trim();
    if (!remoteId || !localStream) return alert("Generate ID and enter a peer ID");
    statusSpan.textContent = 'Status: Calling...';
    currentCall = peer.call(remoteId, localStream);
    currentCall.on('stream', remoteStream => {
        remoteVideo.srcObject = remoteStream;
        statusSpan.textContent = 'Status: Connected';
    });
    currentCall.on('close', () => {
        remoteVideo.srcObject = null;
        statusSpan.textContent = 'Status: Call Ended';
    });
};

// End call
endCallBtn.onclick = () => {
    if (currentCall) currentCall.close();
    remoteVideo.srcObject = null;
    statusSpan.textContent = 'Status: Idle';
};

// Mute/Unmute
muteBtn.onclick = () => {
    if (!localStream) return;
    localStream.getAudioTracks()[0].enabled = muted;
    muted = !muted;
};

// Copy Peer ID
copyIdBtn.onclick = () => {
    if (!peer || !peer.id) return alert("Generate your ID first");
    navigator.clipboard.writeText(peer.id).then(() => alert("ID copied!"));
};

// Make local video draggable
localVideo.onmousedown = function(event) {
  let shiftX = event.clientX - localVideo.getBoundingClientRect().left;
  let shiftY = event.clientY - localVideo.getBoundingClientRect().top;

  function moveAt(pageX, pageY) {
    localVideo.style.left = pageX - shiftX + 'px';
    localVideo.style.top = pageY - shiftY + 'px';
  }

  function onMouseMove(event) {
    moveAt(event.pageX, event.pageY);
  }

  document.addEventListener('mousemove', onMouseMove);
  localVideo.onmouseup = () => {
    document.removeEventListener('mousemove', onMouseMove);
    localVideo.onmouseup = null;
  };
};
localVideo.ondragstart = () => false;
</script>

</body>
</html>